
# 项目介绍

项目分为管理端和用户端。

用户端允许用户进行项目的登录，在用户登录成功之后，用户可以拥有权限去添加自定义任务，定义任务的内容，发送时间，接收人等。同时，由于消息通过的是电子邮件发送，因此要求用户开启对应的电子邮件发送的权限以及接收方也要开启电子邮件，否则将无法方便的看到收发的电子邮件。

比如我的微信绑定了我的QQ邮箱，因此我能在微信查看QQ邮箱收到的邮件。同时我也可以使用自己的QQ邮箱查看我的短信是否发送成功。

情况如下：

![https://cdn.nlark.com/yuque/0/2023/png/34806522/1677138449929-17a783a9-adff-4aa0-b8f1-05b30ea70c34.png](https://www.notion.so/image/https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2023%2Fpng%2F34806522%2F1677138449929-17a783a9-adff-4aa0-b8f1-05b30ea70c34.png?id=d65fa918-8139-41fa-8df4-54a3df6b0590&table=block&spaceId=b64c4d64-f403-4087-86e0-a1e8fdb8361f&width=2000&userId=c25e5a34-6e8a-4a43-ba9f-f420d2f8d2b7&cache=v2)

对于管理端，管理端可以管理所有的用户自定义的消息，删除一些消息，同时如果某个用户的消息被删除了，那么对应的用户也需要接收到对应的提醒。因此用户端会在其邮箱中接收到对应的消息，邮箱的实现通过数据库实现。

同时管理端可以管理用户信息以及用户权限，用户区分为VIP和非VIP。

请求的流程处理过程也按照这里的模块排序进行。

## Nginx负载均衡与请求重定向模块：

这个模块用于将前端的请求进行接收，并进行请求重定向或者负载均衡。

对于一些单纯只是访问静态页面的请求，我们直接使用Nginx中的缓存为其提供服务。

若其访问的是需要后端代码进行配合的项目，那么我们会将请求发送到Gateway网关中进行处理。

## Gateway网关模块：

网关使用的是spring-gateway，其本质是一个过滤器链。

在当前模块，我们提供了限流，熔断，负载均衡，请求重定向，非法请求过滤，请求头信息存放等功能。

网关模块提供限流和熔断功能，当某一次的请求处理失败后，开启熔断和限流功能，来防止系统的崩溃。

这里我们为网关模块整合了sentinel，这确保了我们可以使用sentinel轻松的控制项目的流量，来防止项目的奔溃。

同时，我们的登录注册请求需要使用到验证码，因此我们在网关模块直接提供了验证码模块，当当前请求需要使用到验证码时，就会为其提供验证码支持，并且我们首先会对验证码进行校验，如果验证码错误，那么直接进行拦截返回，直到用户输入正确的验证码。

同时项目提供黑名单功能，将会拦截部分的黑名单用户，来减少系统受到的威胁。

## SpringSecurity鉴权模块:

可以这样子理解这个模块，我们知道如果是一个正常的项目，我们可以直接使用RESTFUL风格来设定请求的路径和参数，但是对于普通用户，他们肯定是不允许去查询其他用户的信息的，这种操作只允许管理员进行。

那么如果我们使用正常的开发方式，比如我们设定用户查寻自己信息的请求路径为/sys/user/query/{userId}，那么如果对于某些带有恶意的人员，他们可能就可以猜测出可能的查询所有用户信息的路径，比如/admin/user/query/{userId}（查询某个用户）或者/admin/user/query（查询所有用户）。

因此，用户的信息就会直接泄露，那么如何解决这种问题？

首先就是要求当前浏览器发起请求的时候，要求带有我们系统发送给他的token，但是这个token其实只需要一个登录用户都是拥有的，那么为了防止上面的问题，我们就需要在进行一次校验，我们解析出token携带的信息之后，将这个信息放入到数据库去查询，查询当前用户对应的权限，如果权限不允许其进行这种查询操作，那么我们就进行报错返回。因此，使用这种方式，我们就需要多维护一些数据库的表，比如权限表，用户角色表，但是这样子就能解决上面可能出现的问题了，大大提高了系统的安全性。

## Auth授权登录模块：

当前模块用于完成用户之后所有操作的授权，该模块提供用户登录，注册，刷新token有效期，退出等功能。

该模块保证了用户接下来的各种操作能顺利进行。

当用户登录成功后，将会根据当前用户的信息，返回一个token给前端，token解析后可以获取当前用户的userid，username，userkey等信息，而这些信息为接下来的所有操作提供了便利。

同时为了减少系统间的耦合，当前模块使用Feign进行远程调用，调用系统用户模块提供的接口来进行用户信息的获取以及注册等功能。

## 请求处理流程（基本完成）：

项目请求流程：

**前端代码-->Nginx-->Gateway-->Auth模块(远程调用)-->System模块-->Auth模块(登录成功,获得请求头信息)-->访问其他模块-->对应模块通过请求头信息进行处理-->访问成功/失败**

**由于项目使用了SpringSecurity，并且我们对项目的过滤器链进行了封装。**

**所以项目的请求流程处理大概如下：**

**Gateway-SentinelFallbackHandler（熔断限流处理）--->Gateway-AuthFilter（网关鉴权）--->Security-HeaderInterceptor（SecurityContext数据填充）**

根据上面的基本介绍，我们可以知道我们项目的请求流程，当用户访问我们的网页的时候，TA可以随意的浏览我们的网页，当用户开始发送请求后。前端会将请求先发送到Nginx上进行请求重定向或者负载均衡，此时我们的请求会被发送到某一台网关服务器上，网关首先会进行限流熔断处理，之后网关服务器此时对请求进行过滤，如果当前请求需要携带token，但是请求头中没有，那么就报错返回，从而将带有敌意的请求，或者不合法请求直接过滤掉。如果当前请求合法，就执行接下来的逻辑，将请求头中的数据封装到SpringSecurity的SecurityContext中去，之后就开始请求的转发。将请求根据当前的注册中心的信息，分配到特定的后端服务器上进行处理。	而一个用户想要正常的访问我们提供的功能，需要其进行注册登录。	我们会为登录的用户提供token信息，这个信息会被放在请求头中，之后用户的所有请求都会携带这个请求头，我们的网关将请求头中的信息解析完毕后，会对请求头中的信息进行保存，这样子之后如果需要用户信息，我们只需要从保存的地方取出即可。	同时，上面我们提到了我们将注册信息以及获取用户信息设定为了通过远程调用的方式，之所以只需要这两个接口来提供远程调用是因为：

首先用户的注册模块，这是毋庸置疑需要使用远程调用的。

主要介绍的是为什么只需要将用户信息获取的接口提供出来，就不再需要提供用户登录的接口了。

因为我们的登录接口其实就是校验用户的信息是否合法以及是否存在于数据库中，那么我们只需要获取到用户的信息，就可以对用户的这一次登录请求直接进行处理了，因此不再需要额外提供一个登录接口。而我们也会对使用了远程调用的请求进行处理，我们的远程调用处理类实现了RequestInterceptor接口，在项目发送远程请求的时候，也会再次检查请求头中是否封装了合理的用户信息，如果没有依旧是报错返回。

那么用户在注册登录完毕之后，就可以正常的使用我们的项目了，以上就是大致的请求处理流程。

## 系统人员模块：

当前系统只有三个身份：管理员，普通用户，会员用户

### 管理员模块：

1. 管理员登录退出:

   管理员登录后，会在请求头里面设定一个参数叫做from-source，有了这个之后允许管理员访问内部权限方法。

2. 管理用户

3. 点击用户后查询到用户对应的消息设定

4. 用户信息操作

5. 用户对应的消息操作

6. 发布公告消息

7. 管理员对用户的任何操作，用户都必须知道，也就是需要给用户设定一个邮箱来接受管理员或者系统的消息

### 用户模块（普通/会员用户）：

1. 用户注册。

2. 用户登入，登出。（二维码登入，微信接口对接）

3. 修改用户名，密码（头像上传）

4. 绑定情侣，情侣关系签到（附带奖励机制），需要编写一张情侣表。参数为绑定情侣的两个人的userid即可

5. 定时消息设置，VIP可以附带接收方当地天气，温度等等信息,使用特殊字体，能发照片和附件

6. TODO:记录自己的日常博客功能（保留）

7. 用户发送1短信可以选择电子邮件也可以选择使用短信，短信需要收费，电子邮件则每个用户只能有五条的短信上限。

8. TODO:上架商城，纪念日礼物，周年庆礼物等等。(单独的模块)

9. 项目本身不需要盈利，有流量即可，通过广告的方式来收入，旁边需要留白

10. 允许用户上传照片，要么使用OSS服务，要么就是自己纯，需要对照片的格式和大小作限定。

11. 

12. 项目后期考虑手写一个RPC和使用Netty，后期JVM调参。

13. 会员开启后，会过期，过期后需要定时的修改用户会员状态（TODO）

![https://cdn.nlark.com/yuque/0/2023/jpeg/34806522/1677589502417-a4b18e62-58bd-4151-9d67-cecd89f0bd3c.jpeg](https://www.notion.so/image/https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2023%2Fjpeg%2F34806522%2F1677589502417-a4b18e62-58bd-4151-9d67-cecd89f0bd3c.jpeg?id=e30e5360-d831-48f8-b2e7-d121f63f45fa&table=block&spaceId=b64c4d64-f403-4087-86e0-a1e8fdb8361f&width=2000&userId=c25e5a34-6e8a-4a43-ba9f-f420d2f8d2b7&cache=v2)

## 系统任务模块：

注意点：

这里还需要注意一个点，就是，我们知道任务是允许定时发送的，那么在即将发送的时候，如果发生了消息内容的更新怎么办？

我的想法是：我们知道mq是对每个消息都会有一个编号的，那么我们能不能自定义这些编号的格式，比如msg：msgId，那么如果是这种方式，就意味着我们可以寻找到被更新内容的任务了，将其从队列中取出并且重新将更新后的内容放入即可。

### 模块设计思路：

该模块最重要的就是了解xxl-job，这个模块决定了我们项目的核心主题---定时任务的发送。该模块同时需要配合的就是我们的邮件发送模块。任务最基本的就是进行CRUD，也就是允许用户增删改查。之后，我们需要考虑的就是，什么时候要去加载任务。所以，需要考虑到给任务的发送时间，添加一个索引，并且这个发送时间可以不适用datetime，直接使用varchar来存储，然后读取之后，写一个函数去转成对应的时间，然后就可以按照任务的时间进行排序，然后延迟发送。当前模块提供页面给用户进行短信邮件的添加，允许用户设定邮件的发送时间，邮件的接收人，邮件的内容，主题。邮件早期的内容可以只是自定义的内容，之后等我们了解了spring-boot-mail之后，我们可以再添加一些额外的功能，比如添加彩色字体，添加天气。这个模块需要做到的就是，如果用户添加了短信，我们需要知道什么时候去把这个任务去加载到项目中然后准备去发送。这个项目是允许用户不断的去更新，添加，删除，查看他所编辑的邮件的。

### 电子邮件发送模块：

这个模块可以使用hutool提供的send的方法，只需要为参数提供邮件的信息即可。

TODO：这个模块后期需要允许添加附件功能，并且需要了解如何发送html格式的邮件。

![https://cdn.nlark.com/yuque/0/2023/png/34806522/1678188596397-165bb841-d6be-4916-85cf-643580b2e0c6.png](https://www.notion.so/image/https%3A%2F%2Fcdn.nlark.com%2Fyuque%2F0%2F2023%2Fpng%2F34806522%2F1678188596397-165bb841-d6be-4916-85cf-643580b2e0c6.png?id=ad7cd2a4-5fd6-47c5-b683-71c6790c0318&table=block&spaceId=b64c4d64-f403-4087-86e0-a1e8fdb8361f&width=2000&userId=c25e5a34-6e8a-4a43-ba9f-f420d2f8d2b7&cache=v2)

### 用户注册后发送邮件给用户

这里可以编写一个操作，就是在用户注册之后，发送邮件给用户。

可以使用事件监听机制和发布机制来完成这个操作。

**项目架构图：**

## 消息队列模块：

项目早期流量少，我们可以选择使用的是2主2从的同步方式，吞吐量少，但是消息可靠。